"""\nWorkflow Template Updater Module\n\nThis module automatically updates workflow templates based on learned improvements,\noptimizations, and user feedback. It ensures workflows evolve and improve over time.\n\nFeatures:\n- Analyze workflow execution patterns\n- Identify improvement opportunities in templates\n- Automatically update templates with optimizations\n- Version control for template changes\n- A/B testing for template variations\n- Rollback capability for template updates\n\nAuthor: Vy Self-Evolving AI Ecosystem\nPhase: 5 - Evening Implementation System\n"""\n\nimport sqlite3\nimport json\nimport os\nimport hashlib\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Optional, Tuple, Any\nfrom dataclasses import dataclass, asdict\nfrom enum import Enum\nimport difflib\n\n\nclass TemplateType(Enum):\n    """Types of workflow templates"""\n    TASK_AUTOMATION = "task_automation"\n    DATA_PROCESSING = "data_processing"\n    COMMUNICATION = "communication"\n    RESEARCH = "research"\n    OPTIMIZATION = "optimization"\n    DEPLOYMENT = "deployment"\n\n\nclass UpdateType(Enum):\n    """Types of template updates"""\n    OPTIMIZATION = "optimization"\n    BUG_FIX = "bug_fix"\n    FEATURE_ADDITION = "feature_addition"\n    PERFORMANCE = "performance"\n    USER_FEEDBACK = "user_feedback"\n    LEARNED_IMPROVEMENT = "learned_improvement"\n\n\nclass UpdateStatus(Enum):\n    """Status of template update"""\n    PROPOSED = "proposed"\n    TESTING = "testing"\n    APPROVED = "approved"\n    DEPLOYED = "deployed"\n    ROLLED_BACK = "rolled_back"\n    REJECTED = "rejected"\n\n\n@dataclass\nclass WorkflowTemplate:\n    """Workflow template definition"""\n    template_id: str\n    name: str\n    template_type: str\n    version: str\n    content: Dict[str, Any]\n    created_at: str\n    updated_at: str\n    performance_metrics: Dict[str, float]\n    usage_count: int\n    success_rate: float\n\n\n@dataclass\nclass TemplateUpdate:\n    """Template update record"""\n    update_id: str\n    template_id: str\n    update_type: str\n    status: str\n    old_version: str\n    new_version: str\n    changes: Dict[str, Any]\n    rationale: str\n    created_at: str\n    applied_at: Optional[str]\n    performance_impact: Optional[Dict[str, float]]\n\n\n@dataclass\nclass TemplateVersion:\n    """Template version history"""\n    version_id: str\n    template_id: str\n    version: str\n    content: Dict[str, Any]\n    created_at: str\n    created_by: str\n    change_summary: str\n\n\nclass WorkflowTemplateUpdater:\n    """\n    Manages automatic updates to workflow templates\n    """\n    \n    def __init__(self, db_path: str = "~/vy-nexus/data/workflow_templates.db"):\n        """\n        Initialize workflow template updater\n        \n        Args:\n            db_path: Path to templates database\n        """\n        self.db_path = os.path.expanduser(db_path)\n        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)\n        self._init_database()\n        \n    def _init_database(self):\n        """Initialize database schema"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        # Templates table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS workflow_templates (\n                template_id TEXT PRIMARY KEY,\n                name TEXT NOT NULL,\n                template_type TEXT NOT NULL,\n                version TEXT NOT NULL,\n                content TEXT NOT NULL,\n                created_at TEXT NOT NULL,\n                updated_at TEXT NOT NULL,\n                performance_metrics TEXT,\n                usage_count INTEGER DEFAULT 0,\n                success_rate REAL DEFAULT 0.0\n            )\n        ''')\n        \n        # Template updates table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS template_updates (\n                update_id TEXT PRIMARY KEY,\n                template_id TEXT NOT NULL,\n                update_type TEXT NOT NULL,\n                status TEXT NOT NULL,\n                old_version TEXT NOT NULL,\n                new_version TEXT NOT NULL,\n                changes TEXT NOT NULL,\n                rationale TEXT,\n                created_at TEXT NOT NULL,\n                applied_at TEXT,\n                performance_impact TEXT,\n                FOREIGN KEY (template_id) REFERENCES workflow_templates(template_id)\n            )\n        ''')\n        \n        # Version history table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS template_versions (\n                version_id TEXT PRIMARY KEY,\n                template_id TEXT NOT NULL,\n                version TEXT NOT NULL,\n                content TEXT NOT NULL,\n                created_at TEXT NOT NULL,\n                created_by TEXT NOT NULL,\n                change_summary TEXT,\n                FOREIGN KEY (template_id) REFERENCES workflow_templates(template_id)\n            )\n        ''')\n        \n        # Template execution logs\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS template_executions (\n                execution_id TEXT PRIMARY KEY,\n                template_id TEXT NOT NULL,\n                version TEXT NOT NULL,\n                executed_at TEXT NOT NULL,\n                duration_seconds REAL,\n                success INTEGER,\n                error_message TEXT,\n                performance_data TEXT,\n                FOREIGN KEY (template_id) REFERENCES workflow_templates(template_id)\n            )\n        ''')\n        \n        # A/B testing table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS ab_tests (\n                test_id TEXT PRIMARY KEY,\n                template_id TEXT NOT NULL,\n                variant_a_version TEXT NOT NULL,\n                variant_b_version TEXT NOT NULL,\n                started_at TEXT NOT NULL,\n                ended_at TEXT,\n                variant_a_executions INTEGER DEFAULT 0,\n                variant_b_executions INTEGER DEFAULT 0,\n                variant_a_success_rate REAL DEFAULT 0.0,\n                variant_b_success_rate REAL DEFAULT 0.0,\n                winner TEXT,\n                FOREIGN KEY (template_id) REFERENCES workflow_templates(template_id)\n            )\n        ''')\n        \n        conn.commit()\n        conn.close()\n    \n    def create_template(self, name: str, template_type: TemplateType,\n                       content: Dict[str, Any]) -> WorkflowTemplate:\n        """\n        Create a new workflow template\n        \n        Args:\n            name: Template name\n            template_type: Type of template\n            content: Template content\n            \n        Returns:\n            WorkflowTemplate object\n        """\n        template_id = hashlib.sha256(\n            f\"{name}:{template_type.value}:{datetime.now().isoformat()}\".encode()\n        ).hexdigest()[:16]\n        \n        template = WorkflowTemplate(\n            template_id=template_id,\n            name=name,\n            template_type=template_type.value,\n            version=\"1.0.0\",\n            content=content,\n            created_at=datetime.now().isoformat(),\n            updated_at=datetime.now().isoformat(),\n            performance_metrics={},\n            usage_count=0,\n            success_rate=0.0\n        )\n        \n        self._save_template(template)\n        self._create_version(template, \"Initial version\", \"system\")\n        \n        return template\n    \n    def propose_update(self, template_id: str, update_type: UpdateType,\n                      changes: Dict[str, Any], rationale: str) -> TemplateUpdate:\n        """\n        Propose an update to a template\n        \n        Args:\n            template_id: Template to update\n            update_type: Type of update\n            changes: Proposed changes\n            rationale: Reason for update\n            \n        Returns:\n            TemplateUpdate object\n        """\n        template = self._get_template(template_id)\n        if not template:\n            raise ValueError(f\"Template {template_id} not found\")\n        \n        # Generate new version number\n        new_version = self._increment_version(template.version, update_type)\n        \n        update_id = hashlib.sha256(\n            f\"{template_id}:{new_version}:{datetime.now().isoformat()}\".encode()\n        ).hexdigest()[:16]\n        \n        update = TemplateUpdate(\n            update_id=update_id,\n            template_id=template_id,\n            update_type=update_type.value,\n            status=UpdateStatus.PROPOSED.value,\n            old_version=template.version,\n            new_version=new_version,\n            changes=changes,\n            rationale=rationale,\n            created_at=datetime.now().isoformat(),\n            applied_at=None,\n            performance_impact=None\n        )\n        \n        self._save_update(update)\n        \n        return update\n    \n    def apply_update(self, update_id: str) -> bool:\n        """\n        Apply a proposed update\n        \n        Args:\n            update_id: Update to apply\n            \n        Returns:\n            True if successful\n        """\n        update = self._get_update(update_id)\n        if not update or update.status != UpdateStatus.PROPOSED.value:\n            return False\n        \n        template = self._get_template(update.template_id)\n        if not template:\n            return False\n        \n        # Apply changes to template content\n        new_content = template.content.copy()\n        for key, value in update.changes.items():\n            if key.startswith('add_'):\n                field = key[4:]\n                new_content[field] = value\n            elif key.startswith('remove_'):\n                field = key[7:]\n                new_content.pop(field, None)\n            elif key.startswith('modify_'):\n                field = key[7:]\n                new_content[field] = value\n            else:\n                new_content[key] = value\n        \n        # Update template\n        template.content = new_content\n        template.version = update.new_version\n        template.updated_at = datetime.now().isoformat()\n        \n        self._save_template(template)\n        \n        # Create version history\n        self._create_version(template, update.rationale, \"auto-updater\")\n        \n        # Update status\n        update.status = UpdateStatus.DEPLOYED.value\n        update.applied_at = datetime.now().isoformat()\n        self._save_update(update)\n        \n        return True\n    \n    def analyze_template_performance(self, template_id: str,\n                                    days: int = 30) -> Dict[str, Any]:\n        """\n        Analyze template performance\n        \n        Args:\n            template_id: Template to analyze\n            days: Number of days to analyze\n            \n        Returns:\n            Performance analysis\n        """\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cutoff = (datetime.now() - timedelta(days=days)).isoformat()\n        \n        cursor.execute('''\n            SELECT COUNT(*),\n                   AVG(duration_seconds),\n                   SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) * 1.0 / COUNT(*),\n                   AVG(CASE WHEN success = 0 THEN 1 ELSE 0 END)\n            FROM template_executions\n            WHERE template_id = ? AND executed_at >= ?\n        ''', (template_id, cutoff))\n        \n        stats = cursor.fetchone()\n        conn.close()\n        \n        if stats[0]:\n            return {\n                'total_executions': stats[0],\n                'avg_duration': stats[1] or 0.0,\n                'success_rate': stats[2] or 0.0,\n                'error_rate': stats[3] or 0.0,\n                'performance_trend': self._calculate_trend(template_id, days)\n            }\n        \n        return {\n            'total_executions': 0,\n            'avg_duration': 0.0,\n            'success_rate': 0.0,\n            'error_rate': 0.0,\n            'performance_trend': 'insufficient_data'\n        }\n    \n    def identify_improvement_opportunities(self, template_id: str) -> List[Dict[str, Any]]:\n        """\n        Identify opportunities to improve template\n        \n        Args:\n            template_id: Template to analyze\n            \n        Returns:\n            List of improvement opportunities\n        """\n        performance = self.analyze_template_performance(template_id)\n        opportunities = []\n        \n        # Low success rate\n        if performance['success_rate'] < 0.8:\n            opportunities.append({\n                'type': 'reliability',\n                'severity': 'high',\n                'description': 'Success rate below 80% - add error handling',\n                'suggested_changes': {\n                    'add_error_handling': True,\n                    'add_retry_logic': True,\n                    'add_validation': True\n                }\n            })\n        \n        # Slow execution\n        if performance['avg_duration'] > 60.0:\n            opportunities.append({\n                'type': 'performance',\n                'severity': 'medium',\n                'description': 'Average duration over 60s - optimize execution',\n                'suggested_changes': {\n                    'add_caching': True,\n                    'optimize_queries': True,\n                    'add_parallelization': True\n                }\n            })\n        \n        # High error rate\n        if performance['error_rate'] > 0.1:\n            opportunities.append({\n                'type': 'stability',\n                'severity': 'high',\n                'description': 'Error rate above 10% - improve stability',\n                'suggested_changes': {\n                    'add_input_validation': True,\n                    'improve_error_messages': True,\n                    'add_fallback_logic': True\n                }\n            })\n        \n        return opportunities\n    \n    def auto_generate_updates(self, template_id: str) -> List[TemplateUpdate]:\n        """\n        Automatically generate update proposals\n        \n        Args:\n            template_id: Template to update\n            \n        Returns:\n            List of proposed updates\n        """\n        opportunities = self.identify_improvement_opportunities(template_id)\n        updates = []\n        \n        for opp in opportunities:\n            update = self.propose_update(\n                template_id=template_id,\n                update_type=UpdateType.LEARNED_IMPROVEMENT,\n                changes=opp['suggested_changes'],\n                rationale=opp['description']\n            )\n            updates.append(update)\n        \n        return updates\n    \n    def start_ab_test(self, template_id: str, variant_b_changes: Dict[str, Any]) -> str:\n        """\n        Start A/B test for template variant\n        \n        Args:\n            template_id: Template to test\n            variant_b_changes: Changes for variant B\n            \n        Returns:\n            Test ID\n        """\n        template = self._get_template(template_id)\n        if not template:\n            raise ValueError(f\"Template {template_id} not found\")\n        \n        # Create variant B\n        variant_b_version = self._increment_version(template.version, UpdateType.OPTIMIZATION)\n        \n        test_id = hashlib.sha256(\n            f\"{template_id}:ab_test:{datetime.now().isoformat()}\".encode()\n        ).hexdigest()[:16]\n        \n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            INSERT INTO ab_tests\n            (test_id, template_id, variant_a_version, variant_b_version, started_at)\n            VALUES (?, ?, ?, ?, ?)\n        ''', (\n            test_id,\n            template_id,\n            template.version,\n            variant_b_version,\n            datetime.now().isoformat()\n        ))\n        \n        conn.commit()\n        conn.close()\n        \n        return test_id\n    \n    def get_template_diff(self, template_id: str, version1: str, version2: str) -> str:\n        """\n        Get diff between two template versions\n        \n        Args:\n            template_id: Template ID\n            version1: First version\n            version2: Second version\n            \n        Returns:\n            Diff string\n        """\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            SELECT content FROM template_versions\n            WHERE template_id = ? AND version = ?\n        ''', (template_id, version1))\n        v1 = cursor.fetchone()\n        \n        cursor.execute('''\n            SELECT content FROM template_versions\n            WHERE template_id = ? AND version = ?\n        ''', (template_id, version2))\n        v2 = cursor.fetchone()\n        \n        conn.close()\n        \n        if v1 and v2:\n            content1 = json.dumps(json.loads(v1[0]), indent=2).splitlines()\n            content2 = json.dumps(json.loads(v2[0]), indent=2).splitlines()\n            \n            diff = difflib.unified_diff(content1, content2, lineterm='')\n            return '\\n'.join(diff)\n        \n        return \"Version not found\"\n    \n    def rollback_template(self, template_id: str, target_version: str) -> bool:\n        """\n        Rollback template to previous version\n        \n        Args:\n            template_id: Template to rollback\n            target_version: Version to rollback to\n            \n        Returns:\n            True if successful\n        """\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            SELECT content FROM template_versions\n            WHERE template_id = ? AND version = ?\n        ''', (template_id, target_version))\n        \n        row = cursor.fetchone()\n        conn.close()\n        \n        if row:\n            template = self._get_template(template_id)\n            if template:\n                template.content = json.loads(row[0])\n                template.version = target_version\n                template.updated_at = datetime.now().isoformat()\n                self._save_template(template)\n                return True\n        \n        return False\n    \n    def _increment_version(self, current: str, update_type: UpdateType) -> str:\n        """Increment version number based on update type"""\n        parts = current.split('.')\n        major, minor, patch = int(parts[0]), int(parts[1]), int(parts[2])\n        \n        if update_type in [UpdateType.FEATURE_ADDITION, UpdateType.LEARNED_IMPROVEMENT]:\n            minor += 1\n            patch = 0\n        elif update_type == UpdateType.BUG_FIX:\n            patch += 1\n        else:\n            patch += 1\n        \n        return f\"{major}.{minor}.{patch}\"\n    \n    def _calculate_trend(self, template_id: str, days: int) -> str:\n        """Calculate performance trend"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cutoff = (datetime.now() - timedelta(days=days)).isoformat()\n        midpoint = (datetime.now() - timedelta(days=days//2)).isoformat()\n        \n        # First half\n        cursor.execute('''\n            SELECT AVG(CASE WHEN success = 1 THEN 1.0 ELSE 0.0 END)\n            FROM template_executions\n            WHERE template_id = ? AND executed_at >= ? AND executed_at < ?\n        ''', (template_id, cutoff, midpoint))\n        first_half = cursor.fetchone()[0]\n        \n        # Second half\n        cursor.execute('''\n            SELECT AVG(CASE WHEN success = 1 THEN 1.0 ELSE 0.0 END)\n            FROM template_executions\n            WHERE template_id = ? AND executed_at >= ?\n        ''', (template_id, midpoint))\n        second_half = cursor.fetchone()[0]\n        \n        conn.close()\n        \n        if first_half and second_half:\n            if second_half > first_half + 0.05:\n                return 'improving'\n            elif second_half < first_half - 0.05:\n                return 'declining'\n            else:\n                return 'stable'\n        \n        return 'insufficient_data'\n    \n    def _save_template(self, template: WorkflowTemplate):\n        """Save template to database"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            INSERT OR REPLACE INTO workflow_templates\n            (template_id, name, template_type, version, content, created_at,\n             updated_at, performance_metrics, usage_count, success_rate)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        ''', (\n            template.template_id,\n            template.name,\n            template.template_type,\n            template.version,\n            json.dumps(template.content),\n            template.created_at,\n            template.updated_at,\n            json.dumps(template.performance_metrics),\n            template.usage_count,\n            template.success_rate\n        ))\n        \n        conn.commit()\n        conn.close()\n    \n    def _get_template(self, template_id: str) -> Optional[WorkflowTemplate]:\n        """Get template from database"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            SELECT * FROM workflow_templates WHERE template_id = ?\n        ''', (template_id,))\n        \n        row = cursor.fetchone()\n        conn.close()\n        \n        if row:\n            return WorkflowTemplate(\n                template_id=row[0],\n                name=row[1],\n                template_type=row[2],\n                version=row[3],\n                content=json.loads(row[4]),\n                created_at=row[5],\n                updated_at=row[6],\n                performance_metrics=json.loads(row[7]) if row[7] else {},\n                usage_count=row[8],\n                success_rate=row[9]\n            )\n        \n        return None\n    \n    def _save_update(self, update: TemplateUpdate):\n        """Save update to database"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            INSERT OR REPLACE INTO template_updates\n            (update_id, template_id, update_type, status, old_version, new_version,\n             changes, rationale, created_at, applied_at, performance_impact)\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n        ''', (\n            update.update_id,\n            update.template_id,\n            update.update_type,\n            update.status,\n            update.old_version,\n            update.new_version,\n            json.dumps(update.changes),\n            update.rationale,\n            update.created_at,\n            update.applied_at,\n            json.dumps(update.performance_impact) if update.performance_impact else None\n        ))\n        \n        conn.commit()\n        conn.close()\n    \n    def _get_update(self, update_id: str) -> Optional[TemplateUpdate]:\n        """Get update from database"""\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            SELECT * FROM template_updates WHERE update_id = ?\n        ''', (update_id,))\n        \n        row = cursor.fetchone()\n        conn.close()\n        \n        if row:\n            return TemplateUpdate(\n                update_id=row[0],\n                template_id=row[1],\n                update_type=row[2],\n                status=row[3],\n                old_version=row[4],\n                new_version=row[5],\n                changes=json.loads(row[6]),\n                rationale=row[7],\n                created_at=row[8],\n                applied_at=row[9],\n                performance_impact=json.loads(row[10]) if row[10] else None\n            )\n        \n        return None\n    \n    def _create_version(self, template: WorkflowTemplate, change_summary: str, created_by: str):\n        """Create version history entry"""\n        version_id = hashlib.sha256(\n            f\"{template.template_id}:{template.version}:{datetime.now().isoformat()}\".encode()\n        ).hexdigest()[:16]\n        \n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            INSERT INTO template_versions\n            (version_id, template_id, version, content, created_at, created_by, change_summary)\n            VALUES (?, ?, ?, ?, ?, ?, ?)\n        ''', (\n            version_id,\n            template.template_id,\n            template.version,\n            json.dumps(template.content),\n            datetime.now().isoformat(),\n            created_by,\n            change_summary\n        ))\n        \n        conn.commit()\n        conn.close()\n\n\nif __name__ == \"__main__\":\n    # Example usage\n    updater = WorkflowTemplateUpdater()\n    \n    # Create a template\n    template = updater.create_template(\n        name=\"Data Processing Workflow\",\n        template_type=TemplateType.DATA_PROCESSING,\n        content={\n            'steps': ['load', 'transform', 'validate', 'save'],\n            'timeout': 300,\n            'retry_count': 3\n        }\n    )\n    \n    print(f\"Created template: {template.template_id}\")\n    \n    # Propose an update\n    update = updater.propose_update(\n        template_id=template.template_id,\n        update_type=UpdateType.OPTIMIZATION,\n        changes={'add_caching': True, 'modify_timeout': 600},\n        rationale=\"Improve performance with caching\"\n    )\n    \n    print(f\"Proposed update: {update.update_id}\")\n